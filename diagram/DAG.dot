<!-- Rendizado em https://dreampuf.github.io/GraphvizOnline/ -->

digraph LlamaFineTuningDAG {
    rankdir=TD;
    node [style=filled, fontname="Arial", fontsize=10, 
        fontcolor="black", shape=ellipse, color="gray", fillcolor="lightgray"];

    // Entrada
    DocData [label="ðŸ“„ 508 Documentos de Texto", shape=cylinder, fillcolor="gray",
    fontname="Impact", fontsize=18];
    Doc1[label="ðŸ“„ Doc ", shape=box, fillcolor="lightgray", fontname="Impact"];
    Doc2[label="ðŸ“„ Doc ", shape=box, fillcolor="lightgray", fontname="Impact"];
    Doc4[label="ðŸ“„ Doc ", shape=box, fillcolor="lightgray", fontname="Impact"];
    Doc3[shape=box, label="...", fillcolor="lightgray"];
    DocN[label="ðŸ“„ Doc ", shape=box, fillcolor="lightgray", fontname="Impact"];

    // Preprocessing
    PreprocessingText [label="PrÃ©-Processamento de Texto", shape=rectangle, fillcolor="yellow"];  
    CleanText [label="ðŸ§¹ Limpar Texto", fillcolor="yellow"];
    NormalizeText [label="ðŸ”¤ Normalizar Texto", fillcolor="yellow"];
    WordTokenize [label="âœ‚ï¸ Tokenizar Palavras", fillcolor="yellow"];
    PartitionTokens [label="ðŸ“¦ Particionar em Tokens", fillcolor="yellow"];

    // Embeddings
    Embbedings [label="GeraÃ§Ã£o de Embbedings", shape=rectangle, fillcolor="orange"];
    SegmentText [label="ðŸ§· Segmentar Texto (CLS, SEP, EOF)", fillcolor="orange2"];
    TokensToIdx [label="ðŸ”¢ Tokens â†’ Ãndices", fillcolor="orange2"];
    BPE [label="ðŸ§  Tokenizador BPE", fillcolor="orange2"];
    GenerateEmbeddings [label="ðŸ§  Vetor de Embeddings", fillcolor="orange2"];

    // Treinamento
    InitDistributed [label="[START] torch.distributed", fillcolor="orangered"];
    CommBackend [label="ðŸ“¡ NCCL / GLOO", fillcolor="orangered"];
    BatchNorm [label="âš–ï¸ Sync BatchNorm", fillcolor="orangered"];
    LR_Scheduler [label="ðŸ“ˆ LR Scheduler", fillcolor="orangered"];
    Quantization [label="ðŸ§® QuantizaÃ§Ã£o FP16/BF16", fillcolor="orangered"];
    Optimizer [label="âš™ï¸ Otimizador (Adam/AdamW)", fillcolor="orangered"];
    BatchSize [label="ðŸ” Tamanho do Batch", fillcolor="orangered"];
    EpochLoop [label="ðŸ”„ Loop de Ã‰pocas", fillcolor="orangered"];
    Logging [label="ðŸ“Š Logging de MÃ©tricas", fillcolor="red3", shape=plaintext style=""];
    Checkpoint [label="ðŸ’¾ Model Checkpoint", fillcolor="orangered"];

    // Deploy
    ExportModel [label="ðŸ§³ Exportar ONNX/TorchScript", fillcolor="lightblue"];
    Deploy [label="ðŸš€ Deploy [END]", shape=octagon, fillcolor="lightblue"];

    // // Subgrafos paralelos para cada documento
    // subgraph cluster_doc1 {
    //     label = "Doc1";
    //     CleanText1 [label="ðŸ§¹ Limpar Texto", fillcolor="yellow"];
    //     NormalizeText1 [label="ðŸ”¤ Normalizar Texto", fillcolor="yellow"];
    //     WordTokenize1 [label="âœ‚ï¸ Tokenizar Palavras", fillcolor="yellow"];
    //     PartitionTokens1 [label="ðŸ“¦ Particionar em Tokens", fillcolor="yellow"];
        
    //     CleanText1 -> NormalizeText1 -> WordTokenize1 -> PartitionTokens1;
    // }

    // subgraph cluster_doc2 {
    //     label = "Doc2";
    //     CleanText2 [label="ðŸ§¹ Limpar Texto", fillcolor="yellow"];
    //     NormalizeText2 [label="ðŸ”¤ Normalizar Texto", fillcolor="yellow"];
    //     WordTokenize2 [label="âœ‚ï¸ Tokenizar Palavras", fillcolor="yellow"];
    //     PartitionTokens2 [label="ðŸ“¦ Particionar em Tokens", fillcolor="yellow"];
        
    //     CleanText2 -> NormalizeText2 -> WordTokenize2 -> PartitionTokens2;
    // }

    // subgraph cluster_docN {
    //     label = "DocN";
    //     CleanTextN [label="ðŸ§¹ Limpar Texto", fillcolor="yellow"];
    //     NormalizeTextN [label="ðŸ”¤ Normalizar Texto", fillcolor="yellow"];
    //     WordTokenizeN [label="âœ‚ï¸ Tokenizar Palavras", fillcolor="yellow"];
    //     PartitionTokensN [label="ðŸ“¦ Particionar em Tokens", fillcolor="yellow"];
        
    //     CleanTextN -> NormalizeTextN -> WordTokenizeN -> PartitionTokensN;
    // }

    // // Indicador de documentos intermediÃ¡rios
    // // DocIntermediate [shape=plaintext, label="...", fontsize=24];

    // // Embeddings
    // Embeddings [label="ðŸ§  GeraÃ§Ã£o de Embeddings", shape=rectangle, fillcolor="orange"];

    // // ConexÃµes paralelas
    // DocData -> {CleanText1 CleanText2 CleanTextN}
    // PartitionTokens1 -> Embeddings;
    // PartitionTokens2 -> Embeddings;
    // PartitionTokensN -> Embeddings;


    // ConfiguraÃ§Ã£o do Grafo DAG
    DocData  ->  Doc1 -> PreprocessingText;
    DocData  ->  Doc2 -> PreprocessingText;
    DocData  ->  Doc3 -> PreprocessingText;
    DocData  ->  DocN -> PreprocessingText;
    DocData  ->  Doc4 -> PreprocessingText;
    
    PreprocessingText -> CleanText;
    PreprocessingText -> NormalizeText;
    PreprocessingText -> WordTokenize;
    PreprocessingText -> PartitionTokens;
    
    CleanText -> Embbedings
    NormalizeText -> Embbedings
    WordTokenize -> Embbedings
    PartitionTokens -> Embbedings
    
    Embbedings -> SegmentText;
    Embbedings -> TokensToIdx;
    Embbedings -> BPE;
    Embbedings -> GenerateEmbeddings;

    SegmentText -> InitDistributed;
    TokensToIdx -> InitDistributed;
    BPE         -> InitDistributed;
    GenerateEmbeddings -> InitDistributed;

    // Fine-Tuning Training
    InitDistributed -> CommBackend;
    InitDistributed -> BatchNorm;
    InitDistributed -> LR_Scheduler;
    InitDistributed -> Quantization;
    InitDistributed -> Optimizer;
    InitDistributed -> BatchSize;

    CommBackend -> EpochLoop;
    BatchNorm -> EpochLoop;
    LR_Scheduler -> EpochLoop;
    Quantization -> EpochLoop;
    Optimizer -> EpochLoop;
    BatchSize -> EpochLoop;

    EpochLoop -> Logging [label="evaluate", fillcolor="orangered"];
    EpochLoop -> Checkpoint;

    Checkpoint -> ExportModel -> Deploy;
}
